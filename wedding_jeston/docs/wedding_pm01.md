# 众擎 PM01 婚礼互动机器人 —— 完整需求分析文档

**文档版本**：V1.0  
**适用机型**：EngineAI PM01（人形机器人）  
**开发框架**：ROS2 Humble + engineai_ros2_workspace  
**开发策略**：仿真优先（Mujoco）→ 真机迁移

---

## 1. 项目概述

### 1.1 产品定位

将众擎 PM01 人形机器人打造为婚礼现场的**智能迎宾员 + AI 采访记者**，集"迎宾问候、智能合影、祝福采访"于一体，为婚礼增添科技感与仪式感。

### 1.2 核心价值

| 价值维度 | 描述 |
|----------|------|
| **科技感** | 人形机器人作为婚礼亮点，吸引宾客互动 |
| **仪式感** | 机器人主动问候、配合合影，增强婚礼氛围 |
| **情感价值** | 采访宾客祝福，生成独一无二的婚礼纪念素材 |
| **实时互动** | 支持大屏投屏，现场实时展示互动画面 |

### 1.3 部署场景

- **固定位置**：签到处、合影区、迎宾通道旁
- **运动方式**：下半身固定站立（安全优先），仅上半身（头/腰/双臂）进行互动动作
- **操作模式**：自主互动为主，支持 ROS2 命令远程控制

---

## 2. 硬件约束与能力

### 2.1 可用自由度（上半身）

基于 PM01 URDF 定义，婚礼互动仅使用以下关节：

| 部位 | 关节编号 | 自由度 | 可用动作 | 限位 |
|------|----------|--------|----------|------|
| **头部** | `J23_HEAD_YAW` | 1 DoF (Yaw) | 左右转动 | ±0.61 rad (±35°) |
| **腰部** | `J12_WAIST_YAW` | 1 DoF (Yaw) | 左右转动 | -4.01 ~ 1.57 rad |
| **左臂** | `J13~J17` | 5 DoF | 抬/展/旋/屈 | 见 URDF |
| **右臂** | `J18~J22` | 5 DoF | 抬/展/旋/屈 | 见 URDF |

> ⚠️ **约束**：头部/腰部仅能左右转动（Yaw），无法点头（Pitch）或歪头（Roll）

### 2.2 传感器需求

| 传感器 | 用途 | 建议型号 |
|--------|------|----------|
| **RGB 摄像头** | 人脸检测、手势识别、目标跟踪 | RealSense D435i / USB 摄像头 |
| **麦克风** | 语音唤醒、命令词识别、采访录音 | 阵列麦克风 / 指向性麦克风 |
| **扬声器** | 语音播报、音效播放 | 内置扬声器 |

### 2.3 外设配置（采访模式）

| 外设 | 说明 |
|------|------|
| **手持麦克风**（可选） | 机器人手臂保持"递话筒"姿势，物理降噪效果最好 |
| **LED 指示灯** | 录制状态指示（红灯 = 录制中） |

### 2.4 计算单元架构

基于 EngineAI PM01 的双板架构，结合婚礼互动功能需求，采用**三层计算架构**：

| 层级 | 设备 | IP 地址 | 架构 | 职责定位 |
|------|------|---------|------|----------|
| **应用层** | Host PC | 开发机/服务器 | x86_64 | 大模型推理、STT/TTS、监控调试 |
| **中间层** | Jetson Orin | 192.168.0.162 | ARM64 | 状态机、视觉感知、语音动作管理 |
| **控制层** | NeZha | 192.168.0.163 | x86 | 运动控制、关节通信、安全监控 |

---

## 3. 系统架构设计

### 3.1 三层架构总览

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Host ROS2 (开发机/服务器)                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │   大模型    │  │  语音/文字  │  │  状态监控   │  │ 外部命令   │            │
│  │   (LLM)    │  │  互转(STT/  │  │  界面显示   │  │  发送接口  │            │
│  │            │  │   TTS)     │  │             │  │            │            │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘            │
│         │                │                │                │                   │
│  ┌──────┴────────────────┴────────────────┴────────────────┴──────┐            │
│  │                    ROS2 Topics (DDS)                           │            │
│  │  /wedding/llm/request  /wedding/stt/audio  /wedding/fsm/state  │            │
│  └────────────────────────────────┬───────────────────────────────┘            │
│                                   │                                             │
│                        ┌──────────┴──────────┐                                  │
│                        │     麦克风(USB)      │  ← 用于开发调试/远程采访         │
│                        └─────────────────────┘                                  │
└───────────────────────────────────┬─────────────────────────────────────────────┘
                                    │ WiFi / 以太网 (可降级)
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         Jetson Orin ROS2 (机载 AI 计算)                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │  视觉感知   │  │   状态机    │  │ 语音/动作   │  │  采访录制   │            │
│  │  (人脸/    │  │   (主FSM)   │  │   管理器    │  │ (视频/音频) │            │
│  │  手势识别) │  │             │  │             │  │             │            │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘            │
│         │                │                │                │                   │
│  ┌──────┴──────┐  ┌──────┴──────┐  ┌──────┴──────┐  ┌──────┴──────┐            │
│  │   语音库    │  │   动作库    │  │  命令词VAD  │  │  实时推流   │            │
│  │  (本地音频) │  │ (Pose配置)  │  │  (本地识别) │  │ (RTMP可选)  │            │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐ │
│  │                        硬件接口                                           │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                       │ │
│  │  │ Realsense  │  │   麦克风    │  │   扬声器    │                       │ │
│  │  │ (RGB/深度) │  │  (阵列/指向)│  │  (播放)     │                       │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                       │ │
│  └───────────────────────────────────────────────────────────────────────────┘ │
│                                   │                                             │
│                        ROS2 Topics (DDS)                                        │
│         /wedding/motion/pose   /wedding/motion/look_at   /wedding/fsm/state    │
└───────────────────────────────────┬─────────────────────────────────────────────┘
                                    │ 以太网 (192.168.0.x)
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           NeZha ROS2 (机载运动控制)                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                             │
│  │ 动作消息    │  │  安全监控   │  │ 关节状态   │                             │
│  │  处理器     │  │ (限幅/急停) │  │   获取     │                             │
│  │(JointCmd   │  │             │  │            │                             │
│  │ Adapter)   │  │             │  │            │                             │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                             │
│         │                │                │                                     │
│  ┌──────┴────────────────┴────────────────┴──────┐                             │
│  │         interface_protocol (已有)             │                             │
│  │  /hardware/joint_command  /hardware/joint_state                            │
│  │  /motion/motion_state                         │                             │
│  └───────────────────────────┬───────────────────┘                             │
│                              │                                                  │
└──────────────────────────────┼──────────────────────────────────────────────────┘
                               │ 内部总线 (EtherCAT/CAN)
                               ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          PM01 关节电机 (底层硬件)                                │
│                                                                                 │
│   J00-J11: 下肢 (固定不动)    J12: 腰部    J13-J22: 双臂    J23: 头部           │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 各层模块职责

#### Host ROS2（应用层）

| 模块 | 职责 | 输入 | 输出 |
|------|------|------|------|
| **大模型服务** | 多轮对话生成回复 | 文本（来自 STT） | 回复文本 → Jetson TTS |
| **STT 服务** | 语音转文字 | 音频流（可选远程） | 文本 → 大模型/Jetson |
| **TTS 服务** | 文字转语音 | 文本（大模型输出） | 音频 → Jetson 播放 |
| **状态监控** | 显示机器人状态 | `/wedding/fsm/state` | 可视化界面 |
| **外部命令** | 操作员控制接口 | 用户输入 | `/wedding/fsm/command` |

#### Jetson Orin ROS2（中间层）

| 模块 | 职责 | 输入 | 输出 |
|------|------|------|------|
| **视觉感知** | 人脸检测/手势识别/距离估计 | Realsense 图像 | `/wedding/perception/*` |
| **主状态机** | 状态管理与决策 | 感知事件/语音命令/外部命令 | 动作意图/语音意图 |
| **语音动作管理** | 调度语音库和动作库 | 状态机意图 | 播放/Pose 指令 |
| **命令词 VAD** | 本地语音唤醒/命令识别 | 麦克风音频 | `/wedding/audio/command` |
| **采访录制** | 视频+音频录制 | Realsense + 麦克风 | 本地 MP4 文件 |
| **实时推流** | 可选，推流到大屏 | Realsense 画面 | RTMP/RTSP 流 |

#### NeZha ROS2（控制层）

| 模块 | 职责 | 输入 | 输出 |
|------|------|------|------|
| **动作消息处理** | 将 Pose/LookAt 转为关节指令 | `/wedding/motion/*` | `/hardware/joint_command` |
| **安全监控** | 关节限幅/速度限制/急停 | 关节指令/状态 | 安全过滤后的指令 |
| **关节状态获取** | 读取关节实时状态 | `/hardware/joint_state` | 状态反馈 → Jetson |

### 3.3 模块部署清单

| 模块名称 | 部署位置 | ROS2 节点名 | 说明 |
|----------|----------|-------------|------|
| 大模型服务 | Host | `wedding_llm_node` | 可选，网络降级时不启用 |
| STT 服务 | Host | `wedding_stt_node` | 可选，云端/本地 |
| TTS 服务 | Host | `wedding_tts_node` | 可选，云端/本地 |
| 状态监控 | Host | `wedding_monitor_node` | 调试用 |
| 视觉感知 | Jetson | `wedding_perception_node` | **核心** |
| 主状态机 | Jetson | `wedding_fsm_node` | **核心** |
| 语音动作管理 | Jetson | `wedding_behavior_node` | **核心** |
| 命令词识别 | Jetson | `wedding_kws_node` | 本地识别，低延迟 |
| 采访录制 | Jetson | `wedding_recorder_node` | 可选 |
| 动作适配 | NeZha | `wedding_motion_adapter_node` | **核心** |
| 安全监控 | NeZha | `wedding_safety_node` | **核心** |

### 3.4 数据流向

#### 正常交互流程

```
[Realsense] → [视觉感知@Jetson] → [状态机@Jetson] → [动作管理@Jetson]
                                        ↓
                              [动作适配@NeZha] → [关节电机]
                                        ↓
                              [语音播放@Jetson] → [扬声器]
```

#### 大模型对话流程

```
[麦克风@Jetson] → [VAD@Jetson] → 检测到语音 → [STT@Host] → 文本
                                                    ↓
[扬声器@Jetson] ← [TTS@Host] ← 回复文本 ← [LLM@Host] ← 文本
```

#### 采访录制流程

```
[Realsense@Jetson] ─┬→ [录制@Jetson] → 本地 MP4
                    │
[麦克风@Jetson] ────┘
                    │
                    └→ [推流@Jetson] → RTMP → 大屏
```

### 3.5 网络拓扑与降级策略

#### 网络拓扑

```
┌─────────────────────────────────────────────────────────────────┐
│                        婚礼现场局域网                            │
│                       192.168.0.0/24                            │
│                                                                 │
│   ┌─────────┐      ┌─────────┐      ┌─────────┐                │
│   │  Host   │      │ Jetson  │      │  NeZha  │                │
│   │ (动态IP) │◄────►│  .162   │◄────►│  .163   │                │
│   └─────────┘      └─────────┘      └─────────┘                │
│        │                │                                       │
│        │           ┌────┴────┐                                  │
│        │           │ 大屏接收 │                                  │
│        │           │  (RTMP) │                                  │
│        │           └─────────┘                                  │
│        │                                                        │
│   ┌────┴────┐                                                   │
│   │  路由器  │                                                   │
│   │ (WiFi)  │                                                   │
│   └─────────┘                                                   │
└─────────────────────────────────────────────────────────────────┘
```

#### 降级策略

| 场景 | 正常模式 | 降级模式 | 触发条件 |
|------|----------|----------|----------|
| **语音识别** | Host STT（高精度） | Jetson 本地 KWS（命令词） | Host 网络超时 > 1s |
| **对话生成** | Host LLM（智能） | Jetson 语音库随机播放 | LLM 响应超时 > 3s |
| **TTS 合成** | Host TTS（自然） | Jetson 预录音播放 | TTS 响应超时 > 2s |
| **状态监控** | Host 实时显示 | Jetson 本地日志 | Host 断连 |
| **推流** | RTMP 到大屏 | 仅本地录制 | 网络带宽不足 |

**降级判断逻辑**

```python
# 伪代码
def get_response(user_text):
    try:
        # 尝试使用 Host LLM
        response = call_llm_with_timeout(user_text, timeout=3.0)
        return response
    except TimeoutError:
        # 降级到本地语音库
        log.warn("LLM timeout, fallback to local speech lib")
        return random_select(speech_lib["fallback"])
```

### 3.6 ROS2 Domain 与通信配置

| 配置项 | 值 | 说明 |
|--------|-----|------|
| `ROS_DOMAIN_ID` | 69 | 与 EngineAI 默认保持一致 |
| `RMW_IMPLEMENTATION` | rmw_cyclonedds_cpp | 使用 CycloneDDS |
| `ROS_LOCALHOST_ONLY` | 0 | 允许跨机通信 |

**QoS 配置建议**

| Topic 类型 | Reliability | Durability | History |
|------------|-------------|------------|---------|
| 感知数据 | Best Effort | Volatile | Keep Last 1 |
| 状态反馈 | Reliable | Transient Local | Keep Last 10 |
| 控制命令 | Reliable | Volatile | Keep Last 1 |
| 关节指令 | Best Effort | Volatile | Keep Last 1 |

---

## 4. 核心状态机设计

### 4.1 状态机总览

婚礼互动采用**统一状态机**管理所有行为，包含 **7 个状态**：

| 状态 | 说明 |
|------|------|
| IDLE | 空闲待机 |
| SEARCH | 初步锁定目标，确认意向 |
| TRACKING | 跟随目标，自由沟通 |
| INTERVIEW | 采访录制 |
| PHOTO_POSING | 合影 |
| FAREWELL | 告别 |
| SAFE_STOP | 安全停止（异常处理） |

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        WeddingInteractionFSM 状态转换图                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│                              ┌────────────────┐                                 │
│                              │   SAFE_STOP    │ ◀───── 任意状态异常触发          │
│                              │   (安全停止)    │                                 │
│                              │ • 停止所有动作  │                                 │
│                              │ • 回中立位      │                                 │
│                              └───────┬────────┘                                 │
│                                      │ 安全恢复                                  │
│                                      ▼                                          │
│     ┌──────────┐    检测到人脸(T_detect)    ┌──────────────┐                   │
│     │   IDLE   │ ──────────────────────▶   │    SEARCH    │                   │
│     │  (空闲)   │ ◀──────────────────────   │  (搜寻目标)   │                   │
│     └──────────┘    无目标超时(T_giveup)     └──────┬───────┘                   │
│          ▲                                         │                            │
│          │                                         │ 目标确认(T_lock)            │
│          │                                         │ + 目标有互动意向             │
│          │                                         ▼                            │
│          │    ┌────────────────────────────────────────────────────┐           │
│          │    │                   TRACKING                         │           │
│          │    │               (跟随 + 自由沟通)                      │           │
│          │    │   • 头/腰平滑跟随目标                               │           │
│          │    │   • 主动问候 + 伴随动作                             │           │
│          │    │   • 多轮对话（接入大模型）                          │           │
│          │    │   • 响应手势/语音触发                               │           │
│          │    └──────┬─────────────────────┬───────────────────────┘           │
│          │           │                     │                                    │
│          │           │ 手势/语音触发        │ 目标离开/超时                      │
│          │           ▼                     ▼                                    │
│          │    ┌──────────────┐      ┌──────────────┐                           │
│          │    │ PHOTO_POSING │      │   FAREWELL   │                           │
│          │    │   (合影)      │      │    (送别)    │                           │
│          │    │ • 执行合影动作│      │ • 挥手+送别语│                           │
│          │    │ • 倒数+快门声 │      └──────┬───────┘                           │
│          │    └──────┬───────┘             │                                    │
│          │           │ 完成                 │ 完成                               │
│          │           ▼                     │                                    │
│          │    返回 TRACKING ◀──────────────┘                                    │
│          │           或                                                         │
│          └───────── 返回 IDLE ◀─────────────────────────────────────────────────┘
│                                                                                 │
│                                                                                 │
│          ┌─────────── TRACKING ─────────────┐                                   │
│          │                                  │                                   │
│          │ 语音/命令触发采访                  │                                   │
│          ▼                                  │                                   │
│    ┌──────────────┐                         │                                   │
│    │  INTERVIEW   │ ────────────────────────┘                                   │
│    │   (采访)     │        采访结束                                              │
│    │ • 开启录音   │                                                              │
│    │ • 开启录像   │                                                              │
│    │ • 采访问答   │                                                              │
│    └──────────────┘                                                              │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 状态定义详表

| 状态 | 英文名 | 进入条件 | 退出条件 | 核心行为 |
|------|--------|----------|----------|----------|
| **空闲** | `IDLE` | 无目标 / 送别完成 / 外部命令 / 安全恢复 | 检测到人脸 | 待机微动（头/腰小幅摆动），等待目标 |
| **搜寻目标** | `SEARCH` | 检测到人脸但未锁定 | 目标锁定确认 / 超时放弃 | 头部朝向检测区域，确认目标互动意向 |
| **跟随互动** | `TRACKING` | 目标锁定 + 有互动意向 | 触发合影/采访 / 目标离开 / 外部命令 | 跟随目标，主动问候，多轮对话 |
| **采访** | `INTERVIEW` | 语音/命令触发采访 | 采访结束 / 超时 / 外部命令 | 开启录音录像，采访问答 |
| **合影** | `PHOTO_POSING` | 手势/语音触发 / 外部命令 | 合影完成 | 执行 Pose、倒数、快门声 |
| **送别** | `FAREWELL` | 目标离开视野 | 送别完成 | 挥手 + 送别语 |
| **安全停止** | `SAFE_STOP` | 异常触发（太近/超限/硬件故障） | 安全恢复 / 外部命令 | 停止所有动作，回中立位，等待恢复 |

### 4.3 状态转换触发方式

状态切换支持**两种触发方式**：

#### A. 自动触发（基于感知）

| 触发事件 | 来源 | 状态转换 |
|----------|------|----------|
| 检测到人脸 | 视觉感知 | IDLE → SEARCH |
| 目标锁定 + 有互动意向 | 视觉感知 | SEARCH → TRACKING |
| 无目标超时 | 超时检测 | SEARCH → IDLE |
| 检测到合影手势 | 视觉感知 | TRACKING → PHOTO_POSING |
| 目标离开视野 | 视觉感知 | TRACKING → FAREWELL |
| 合影完成 | 内部事件 | PHOTO_POSING → TRACKING / IDLE |
| 送别完成 | 内部事件 | FAREWELL → IDLE |
| 采访结束 | 内部事件 | INTERVIEW → TRACKING |
| 目标丢失超时 | 超时检测 | * → IDLE |
| 安全异常 | 安全检测 | * → SAFE_STOP |
| 安全恢复 | 安全检测 | SAFE_STOP → IDLE |

#### B. 外部命令触发

| 触发方式 | Topic / 接口 | 命令示例 |
|----------|--------------|----------|
| **ROS2 Topic** | `/wedding/fsm/command` | `{"command": "goto_photo", "pose": "heart"}` |
| **ROS2 Service** | `/wedding/fsm/set_state` | `SetState.srv(target_state="IDLE")` |
| **语音命令** | 语音识别模块 | "拍照" / "合影" / "采访" / "停止" |

**支持的外部命令**

| 命令 | 效果 | 适用场景 |
|------|------|----------|
| `goto_idle` | 强制回到 IDLE | 重置状态 |
| `goto_photo` | 进入合影状态 | 操作员触发合影 |
| `start_interview` | 进入采访模式 | 操作员触发采访 |
| `stop_interview` | 结束采访模式 | 操作员结束采访 |
| `stop` | 停止当前动作，进入 SAFE_STOP | 紧急停止 |
| `reset` | 从 SAFE_STOP 恢复到 IDLE | 安全恢复 |
| `say <text>` | 播报指定文本 | 自定义播报 |

---

## 5. 各状态详细设计

### 5.1 IDLE（空闲）

空闲状态是机器人的默认状态，等待目标出现。

#### 状态特点

- **无主动互动**：仅进行待机微动，不主动说话（降低打扰）
- **持续扫描**：视觉持续检测人脸
- **低能耗**：动作幅度小，语音概率低

#### 动作库

| 动作名 | 描述 | 涉及关节 | 参数 |
|--------|------|----------|------|
| `idle_sway` | 待机微动：头/腰极小幅左右摆动 | HEAD_YAW, WAIST_YAW | 幅度 ±2°~±8°, 周期 2-3s |
| `idle_scan` | 巡视：头部缓慢左右扫描 | HEAD_YAW | 幅度 ±20°, 周期 4-6s |
| `neutral` | 中立位：所有关节回零位 | 全部上半身 | - |

#### 语音库

| 语音类型 | 内容示例 | 触发时机 |
|----------|----------|----------|
| `idle_greeting` | "你好呀，欢迎来到婚礼现场！" | 随机触发（概率 30%，冷却 30s） |
| `idle_welcome` | "欢迎欢迎，今天是个好日子！" | 随机触发 |

#### 状态参数

```yaml
idle:
  switch_interval: 10.0      # 动作包切换间隔（秒）
  speech_probability: 0.3    # 语音触发概率
  speech_cooldown: 30.0      # 语音冷却时间（秒）
  face_confirm_time: 0.3     # 人脸检测确认时间（秒）
```

---

### 5.2 SEARCH（搜寻目标）

初步检测到人脸后进入此状态，用于锁定目标并确认其互动意向。

#### 状态特点

- **目标锁定**：快速转向检测到的人脸方向
- **意向判断**：判断目标是否有互动意向（面向机器人、驻留时间）
- **低打扰**：不主动说话，避免打扰路人

#### 判断逻辑

```
目标锁定条件：
1. 人脸持续检测 > T_lock（0.8s）
2. 人脸在有效区域内（画面中心）
3. 人脸面积在合理范围（不太远也不太近）

互动意向判断：
1. 目标面向机器人（正脸比例 > 70%）
2. 目标驻留时间 > T_engage（2.0s）
3. 目标距离在互动范围内（0.8~3.0m）
```

#### 动作库

| 动作名 | 描述 | 涉及关节 | 参数 |
|--------|------|----------|------|
| `look_at_target` | 头部快速转向目标方向 | HEAD_YAW | 速度 0.5 rad/s |
| `attention_tilt` | 注意力微调：小幅转动表示注意到 | HEAD_YAW, WAIST_YAW | 幅度 ±3° |

#### 语音库

| 语音类型 | 内容示例 | 触发时机 |
|----------|----------|----------|
| 无 | （搜寻阶段不说话，避免打扰路人） | - |

#### 状态参数

```yaml
search:
  T_lock: 0.8           # 目标锁定时间（秒）
  T_engage: 2.0         # 互动意向确认时间（秒）
  T_giveup: 3.0         # 放弃超时（秒）
  facing_threshold: 0.7  # 面向判断阈值
```

---

### 5.3 TRACKING（跟随互动）

核心互动状态，与宾客进行主动交流。

#### 状态特点

- **持续跟随**：头/腰平滑跟随目标位置
- **主动问候**：进入时播放问候语
- **自由对话**：支持多轮对话（大模型/语音库）
- **手势响应**：检测合影手势触发合影

#### 动作库

| 动作名 | 描述 | 涉及关节 | 参数 |
|--------|------|----------|------|
| `smooth_follow` | 平滑跟随目标位置 | HEAD_YAW, WAIST_YAW | 跟随系数 0.3-0.5 |
| `greeting_spread` | 双手微摊（欢迎姿态） | SHOULDER_ROLL L/R | 进入时触发 |
| `listening_nod` | 注视微调（表示在听） | HEAD_YAW | 对话时触发 |
| `curious_tilt` | 好奇偏头（单侧 Yaw 偏转） | HEAD_YAW | 随机触发 |
| `single_wave` | 单手小幅挥动（活跃气氛） | SHOULDER_YAW | 随机触发 |

#### 语音库

| 语音类型 | 内容示例 | 权重 |
|----------|----------|------|
| `greeting` | "欢迎光临~祝新人百年好合！" | 1.0 |
| `greeting` | "您好呀，今天真热闹！" | 0.8 |
| `greeting` | "哇，您今天真好看！" | 0.6 |
| `invitation` | "要不要一起拍张照？比个心就可以哦~" | 1.0 |
| `invitation` | "来，我们合个影吧！" | 0.8 |
| `chat_response` | （大模型生成） | - |

#### 大模型对话接入

| 配置项 | 说明 |
|--------|------|
| **接入方式** | 本地/云端 LLM API |
| **输入** | STT 转写的宾客语音文本 |
| **输出** | LLM 生成的回复文本 → TTS 播报 |
| **超时处理** | 3s 无 LLM 响应 → 使用预设语音库兜底 |
| **安全过滤** | 过滤敏感/不当内容 |

**对话 Prompt 模板**

```
你是婚礼现场的智能机器人助手，今天是一对新人的大喜之日。
请用温暖、幽默、简短的方式回应宾客。
回复控制在 20 字以内，语气亲切活泼。

宾客说：{user_input}
```

#### 状态参数

```yaml
tracking:
  follow_smooth_factor: 0.3   # 跟随平滑系数
  greeting_cooldown: 30.0     # 同一目标问候冷却（秒）
  T_lost: 1.5                 # 目标丢失超时（秒）
  llm_timeout: 3.0            # 大模型响应超时（秒）
```

---

### 5.4 INTERVIEW（采访）

独立的采访状态，用于录制宾客祝福视频。

#### 状态特点

- **录音录像**：同时开启音频和视频录制
- **引导问答**：机器人主动提问，引导宾客说祝福
- **结束检测**：自动检测语音停顿或手势结束

#### 进入/退出条件

| 条件类型 | 说明 |
|----------|------|
| **进入条件** | 语音命令"采访" / ROS2 命令 `start_interview` |
| **退出条件** | VAD 检测语音停顿 > 1.5s / 手势"OK" / 超时 30s / 命令结束 |

#### 动作库

| 动作名 | 描述 | 涉及关节 | 参数 |
|--------|------|----------|------|
| `interview_mic_hold` | 递话筒姿势（单臂前伸） | SHOULDER_PITCH/ROLL, ELBOW | 采访全程 |
| `listening_nod` | 注视微调（表示在听） | HEAD_YAW | 宾客说话时 |
| `interview_end_gesture` | 采访结束手势 | 双臂 | 结束时 |

#### 语音库

| 语音类型 | 内容示例 | 权重 |
|----------|----------|------|
| `interview_start` | "您好，我是今天的特约记者，能送给新人一句祝福吗？" | 1.0 |
| `interview_question` | "您觉得新郎今天帅吗？" | 0.8 |
| `interview_question` | "祝他们早生贵子还是三年抱俩？" | 0.6 |
| `interview_question` | "简单说一句祝福吧！" | 1.0 |
| `interview_end` | "说得太好了！谢谢您的祝福！" | 1.0 |
| `interview_end` | "已收录，新人一定会很开心的！" | 0.8 |

#### 录制功能

| 功能 | 说明 |
|------|------|
| **录制内容** | 视频（摄像头画面）+ 音频（麦克风） |
| **存储路径** | `/home/user/wedding_blessings/blessing_{timestamp}.mp4` |
| **实时推流** | 可选，推送到现场大屏（RTMP/RTSP） |
| **录制时长** | 最长 60s，最短 5s |

#### 状态参数

```yaml
interview:
  max_duration: 60.0          # 最大录制时长（秒）
  min_duration: 5.0           # 最小录制时长（秒）
  silence_timeout: 1.5        # 静音超时（秒）
  question_interval: 10.0     # 提问间隔（秒）
  save_path: "/home/user/wedding_blessings/"
```

---

### 5.5 PHOTO_POSING（合影）

#### 触发方式

| 触发 | 描述 |
|------|------|
| **手势** | 检测到"比心" / "剪刀手 V" 手势 |
| **语音** | 识别到"拍照" / "合影" / "三二一" |
| **ROS2 命令** | `goto_photo` + 可选 `pose` 参数 |

#### 动作库（Pose 库）

| Pose 名称 | 描述 | 关节配置 | 持续时间 |
|-----------|------|----------|----------|
| `heart` | 比心：双臂在胸前交叉成心形 | 双肩 Pitch/Roll, 双肘 Pitch | 3-4s |
| `v_sign` | 剪刀手：单臂抬起，模拟 V 手势 | 单肩 Pitch, 单肘 Pitch/Yaw | 3-4s |
| `thumbs_up` | 点赞：单臂抬起竖大拇指 | 单肩 Pitch/Roll | 3-4s |
| `invite` | 邀请：双手摊开欢迎姿态 | 双肩 Roll, 双肘 Pitch | 3-4s |
| `wave` | 挥手：单臂抬起挥手 | 单肩 Pitch/Yaw | 3-4s |
| `neutral` | 中立位 | 全部回零 | - |

#### 语音库

| 语音类型 | 内容示例 | 触发时机 |
|----------|----------|----------|
| `photo_confirm` | "好的，看镜头！" | 进入合影状态 |
| `photo_confirm` | "收到！准备好了吗？" | 进入合影状态 |
| `countdown` | "3... 2... 1..." | 倒数阶段 |
| `shutter` | "咔嚓！" / 快门音效 | 拍照完成 |
| `photo_done` | "太棒了！拍得真好看！" | 合影结束 |
| `photo_done` | "完美！还想再来一张吗？" | 合影结束 |

#### 合影流程

```
1. 触发 → 进入 PHOTO_POSING
2. 播放确认语 "好的，看镜头！"
3. 执行 Pose 动作（根据手势/参数选择）
4. 保持 Pose 稳定
5. 倒数 "3... 2... 1..."
6. 播放快门声 "咔嚓！"
7. 播放完成语 "太棒了！"
8. 回中立位
9. 返回 TRACKING（可继续互动）或 IDLE
```

---

### 5.6 FAREWELL（送别）

目标离开时进入此状态，进行友好的告别。

#### 状态特点

- **挥手告别**：执行挥手动作
- **播放送别语**：随机选择送别语音
- **短暂持续**：完成后自动回到 IDLE

#### 动作库

| 动作名 | 描述 | 涉及关节 | 参数 |
|--------|------|----------|------|
| `wave_goodbye` | 挥手告别：单臂抬起，肩 Yaw 周期摆动 | SHOULDER_PITCH/YAW | 周期 0.5-0.8s, 持续 2s |
| `slight_bow` | 微鞠躬：腰部小幅前倾（若支持） | - | 不支持则跳过 |

#### 语音库

| 语音类型 | 内容示例 | 权重 |
|----------|----------|------|
| `farewell` | "再见~祝您玩得开心！" | 1.0 |
| `farewell` | "拜拜~记得多吃点好吃的！" | 0.8 |
| `farewell` | "慢走哦~欢迎下次再来！" | 0.6 |
| `farewell` | "感谢您的祝福，新人会很开心的！" | 0.8 |

#### 状态参数

```yaml
farewell:
  duration: 2.0           # 送别持续时间（秒）
  wave_period: 0.6        # 挥手周期（秒）
  wave_amplitude: 0.17    # 挥手幅度（rad，约 ±10°）
```

---

### 5.7 SAFE_STOP（安全停止）

异常情况下的安全状态，确保机器人安全。

#### 状态特点

- **立即停止**：停止所有动作，回到中立位
- **安全优先**：任何状态都可进入
- **等待恢复**：需要外部命令或安全条件解除才能退出

#### 进入条件

| 触发条件 | 描述 |
|----------|------|
| 目标太近 | 目标距离 < 0.5m，可能碰撞 |
| 关节超限 | 关节位置/速度超出安全范围 |
| 命令超时 | 上层命令超时 > 2s |
| 硬件故障 | 关节通信异常 |
| 外部急停 | ROS2 `stop` 命令 |

#### 退出条件

| 恢复条件 | 描述 |
|----------|------|
| 安全条件解除 | 目标距离恢复正常、关节状态正常 |
| 外部命令 | ROS2 `reset` 命令 |
| 超时自动恢复 | 安全状态持续 > 10s 且无异常 |

#### 动作库

| 动作名 | 描述 | 涉及关节 | 参数 |
|--------|------|----------|------|
| `neutral` | 中立位：所有关节平滑回零位 | 全部上半身 | 速度 0.3 rad/s |
| `freeze` | 冻结：保持当前位置不动 | 全部 | - |

#### 语音库

| 语音类型 | 内容示例 | 触发时机 |
|----------|----------|----------|
| `too_close` | "请稍微退后一点哦~" | 目标太近时 |
| `system_error` | "系统检测中，请稍候..." | 硬件异常时 |
| `recovery` | "好啦，我们继续吧！" | 恢复时 |

#### 状态参数

```yaml
safe_stop:
  recovery_timeout: 10.0      # 自动恢复超时（秒）
  too_close_threshold: 0.5    # 太近阈值（米）
  neutral_speed: 0.3          # 回中立位速度（rad/s）
  watchdog_timeout: 2.0       # 命令看门狗超时（秒）
```

#### 安全逻辑流程

```
1. 任意状态检测到安全触发
   ↓
2. 立即进入 SAFE_STOP
   ↓
3. 停止所有动作
   ↓
4. 平滑回中立位
   ↓
5. 播放提示语音（如适用）
   ↓
6. 等待恢复条件
   ├── 安全条件解除 → 恢复到 IDLE
   ├── 外部 reset 命令 → 恢复到 IDLE
   └── 超时自动恢复 → 恢复到 IDLE
```

---

## 6. 模块接口设计

### 6.1 ROS2 Topic 接口

#### 输入 Topic（订阅）

| Topic 名称 | 消息类型 | 频率 | 描述 |
|------------|----------|------|------|
| `/wedding/perception/target` | `geometry_msgs/PointStamped` | 20-30Hz | 目标位置（归一化图像坐标） |
| `/wedding/perception/gesture` | `std_msgs/String` | 事件 | 检测到的手势（heart/v/ok/none） |
| `/wedding/perception/face_count` | `std_msgs/Int32` | 10Hz | 画面中人脸数量 |
| `/wedding/perception/too_close` | `std_msgs/Bool` | 10Hz | 目标是否过近 |
| `/wedding/audio/command` | `std_msgs/String` | 事件 | 语音命令（拍照/采访/停止） |
| `/wedding/fsm/command` | `std_msgs/String` | 事件 | 外部控制命令（JSON 格式） |

#### 输出 Topic（发布）

| Topic 名称 | 消息类型 | 频率 | 描述 |
|------------|----------|------|------|
| `/wedding/fsm/state` | `std_msgs/String` | 5Hz | 当前状态名称 |
| `/wedding/fsm/substate` | `std_msgs/String` | 5Hz | 当前子状态（如 GREETING_MODE） |
| `/wedding/motion/pose` | `std_msgs/String` | 事件 | 目标 Pose 名称 |
| `/wedding/motion/look_at` | `geometry_msgs/PointStamped` | 20Hz | 目标注视位置 |
| `/wedding/audio/play` | `std_msgs/String` | 事件 | 播放的语音资源名 |
| `/wedding/audio/tts` | `std_msgs/String` | 事件 | TTS 文本（大模型输出） |
| `/wedding/interview/status` | `std_msgs/String` | 事件 | 采访状态（recording/stopped） |

#### 底层接口（对接 EngineAI）

| Topic 名称 | 消息类型 | 方向 | 描述 |
|------------|----------|------|------|
| `/hardware/joint_state` | `interface_protocol/JointState` | Sub | 当前关节状态 |
| `/hardware/joint_command` | `interface_protocol/JointCommand` | Pub | 关节指令（上半身） |
| `/motion/motion_state` | `interface_protocol/MotionState` | Sub | 运动状态（判断是否可控制） |

### 6.2 ROS2 Service 接口

| Service 名称 | 类型 | 描述 |
|--------------|------|------|
| `/wedding/fsm/set_state` | `std_srvs/SetBool` | 强制设置状态 |
| `/wedding/interview/start` | `std_srvs/Trigger` | 启动采访录制 |
| `/wedding/interview/stop` | `std_srvs/Trigger` | 停止采访录制 |

---

## 7. 语音控制命令表

| 语音命令 | 动作 | 状态转换 |
|----------|------|----------|
| "拍照" / "合影" | 进入合影状态 | TRACKING → PHOTO_POSING |
| "比心" | 进入合影状态，执行比心 Pose | TRACKING → PHOTO_POSING (heart) |
| "采访" / "采访一下" | 进入采访模式 | TRACKING → INTERVIEW |
| "停止" / "结束" | 停止当前动作，回中立位 | * → SAFE_STOP → IDLE |
| "你好" / "你好机器人" | 唤醒，进入互动模式 | IDLE → SEARCH → TRACKING |
| "继续" / "恢复" | 从安全停止恢复 | SAFE_STOP → IDLE |

---

## 8. 配置文件结构

### 8.1 状态机参数 (`fsm_config.yaml`)

```yaml
fsm:
  # 全局参数
  rate: 50.0                    # FSM 运行频率 (Hz)
  state_pub_rate: 5.0           # 状态发布频率 (Hz)

# ========== 各状态参数 ==========

idle:
  switch_interval: 10.0         # 动作包切换间隔 (s)
  speech_probability: 0.3       # 语音触发概率
  speech_cooldown: 30.0         # 语音冷却时间 (s)
  face_confirm_time: 0.3        # 人脸检测确认时间 (s)

search:
  T_lock: 0.8                   # 目标稳定锁定时间 (s)
  T_engage: 2.0                 # 互动意向确认时间 (s)
  T_giveup: 3.0                 # 搜索放弃超时 (s)
  facing_threshold: 0.7         # 面向判断阈值

tracking:
  follow_smooth_factor: 0.3     # 跟随平滑系数
  greeting_cooldown: 30.0       # 同一目标问候冷却 (s)
  T_lost: 1.5                   # 目标丢失超时 (s)
  llm_timeout: 3.0              # 大模型响应超时 (s)

interview:
  max_duration: 60.0            # 最大录制时长 (s)
  min_duration: 5.0             # 最小录制时长 (s)
  silence_timeout: 1.5          # 静音超时 (s)
  question_interval: 10.0       # 提问间隔 (s)
  save_path: "/home/user/wedding_blessings/"

photo_posing:
  pose_duration: 3.0            # Pose 保持时间 (s)
  countdown_interval: 1.0       # 倒数间隔 (s)
  cooldown: 3.0                 # 合影冷却 (s)

farewell:
  duration: 2.0                 # 送别持续时间 (s)
  wave_period: 0.6              # 挥手周期 (s)
  wave_amplitude: 0.17          # 挥手幅度 (rad)

safe_stop:
  recovery_timeout: 10.0        # 自动恢复超时 (s)
  too_close_threshold: 0.5      # 太近阈值 (m)
  neutral_speed: 0.3            # 回中立位速度 (rad/s)
  watchdog_timeout: 2.0         # 命令看门狗超时 (s)

# ========== 感知参数 ==========

perception:
  distance_range: [0.8, 3.0]    # 有效互动距离 (m)
  face_area_min: 0.02           # 人脸框最小面积（归一化）
  face_area_max: 0.25           # 人脸框最大面积（太近）
  center_region: [0.2, 0.8, 0.1, 0.9]  # 画面中心区域
  gesture_confirm_time: 0.3     # 手势确认时间 (s)
```

### 8.2 动作库配置 (`poses.yaml`)

```yaml
poses:
  neutral:
    description: "中立位"
    joints:
      WAIST_YAW: 0.0
      HEAD_YAW: 0.0
      SHOULDER_PITCH_L: 0.0
      SHOULDER_ROLL_L: 0.054
      # ... 其他关节
    duration: 1.0
    
  heart:
    description: "比心"
    joints:
      SHOULDER_PITCH_L: -0.5
      SHOULDER_ROLL_L: 0.3
      ELBOW_PITCH_L: -0.8
      # ... 右臂对称
    duration: 3.0
    
  wave:
    description: "挥手"
    joints:
      SHOULDER_PITCH_R: -0.8
      SHOULDER_YAW_R: 0.0  # 周期摆动
    oscillation:
      joint: SHOULDER_YAW_R
      amplitude: 0.17  # ±10°
      period: 0.6
    duration: 2.0
```

### 8.3 语音库配置 (`speech.yaml`)

```yaml
speech:
  greetings:
    - text: "欢迎光临~祝新人百年好合！"
      weight: 1.0
      gesture: "greeting_spread"
    - text: "您好呀，今天真热闹！"
      weight: 0.8
      gesture: "greeting_spread"
      
  photo_confirm:
    - text: "好的，看镜头！"
      weight: 1.0
    - text: "收到！准备好了吗？"
      weight: 0.8
      
  countdown:
    - text: "3... 2... 1..."
      
  farewells:
    - text: "再见~祝您玩得开心！"
      weight: 1.0
      gesture: "wave_goodbye"
```

---

## 9. 开发优先级与里程碑（2 周冲刺计划）

> ⏰ **时间约束**：2 周（10 个工作日）  
> 🎯 **目标**：交付可演示的 MVP（视觉跟随 + 合影动作 + 语音播放）  
> 📋 **策略**：仿真与真机并行开发，聚焦核心体验，高级功能降级或延后

### 9.1 功能优先级划分

| 优先级 | 功能 | 必要性 | 2 周内目标 |
|--------|------|--------|------------|
| **P0 必须** | 视觉跟随（头/腰） | 核心体验 | ✅ 完成 |
| **P0 必须** | 合影动作（Pose） | 核心体验 | ✅ 完成 |
| **P0 必须** | 语音播放（预录音） | 核心体验 | ✅ 完成 |
| **P1 重要** | 手势触发（比心/V） | 提升体验 | ✅ 完成 |
| **P1 重要** | 状态机基础流程 | 流程完整 | ✅ 完成 |
| **P2 可选** | 语音命令识别 | 便捷性 | ⚠️ 视时间 |
| **P2 可选** | 送别动作 | 完整性 | ⚠️ 视时间 |
| **P3 延后** | 大模型对话 | 高级功能 | ❌ 降级为语音库 |
| **P3 延后** | 采访录制 | 高级功能 | ❌ 延后 |
| **P3 延后** | 实时推流 | 高级功能 | ❌ 延后 |

### 9.2 两周开发计划

#### Week 1: 核心功能开发（Day 1-5）

**Day 1: 环境搭建 + 框架设计**
- [ ] 搭建开发环境（ROS2 Humble + engineai_ros2_workspace）
- [ ] 验证仿真环境（Mujoco）可运行
- [ ] 验证真机连接（Jetson + NeZha 网络通信）
- [ ] 创建 `wedding_interaction` ROS2 包骨架
- [ ] 定义核心 Topic 接口

**Day 2: 视觉感知节点**
- [ ] 实现 `wedding_perception_node`（Jetson）
- [ ] 集成 MediaPipe Face Detection
- [ ] 输出目标位置 `/wedding/perception/target`
- [ ] 在仿真/真机摄像头上验证

**Day 3: 运动适配节点**
- [ ] 实现 `wedding_motion_adapter_node`（NeZha）
- [ ] 实现 head/waist 跟随逻辑
- [ ] 实现关节限幅 + 平滑插值
- [ ] 在仿真中验证跟随效果

**Day 4: 状态机 + 手势识别**
- [ ] 实现简化状态机（IDLE → TRACKING → PHOTO_POSING）
- [ ] 集成 MediaPipe Hands 手势识别
- [ ] 实现手势触发合影（比心/V）

**Day 5: 合影动作 + 语音播放**
- [ ] 定义 Pose 库（heart/v_sign/neutral）
- [ ] 实现 Pose 执行逻辑
- [ ] 实现语音播放节点（预录音）
- [ ] 准备音频素材（欢迎语/倒数/快门声）

**Week 1 交付物**：仿真环境下可演示"看到人 → 跟随 → 检测手势 → 合影动作 → 播放语音"

---

#### Week 2: 真机迁移 + 完善（Day 6-10）

**Day 6: 真机迁移**
- [ ] 部署节点到 Jetson + NeZha
- [ ] 验证 ROS2 跨机通信
- [ ] 调试关节控制参数（PD 参数、速度限制）
- [ ] 真机跟随测试

**Day 7: 真机调优**
- [ ] 调整视觉检测参数（适应真机摄像头）
- [ ] 调整 Pose 关节角度（真机校准）
- [ ] 解决真机特有问题（延迟、噪声）

**Day 8: 状态机完善**
- [ ] 完善状态转换逻辑（超时回退、目标丢失）
- [ ] 实现 FAREWELL 状态（挥手 + 送别语）
- [ ] 增加安全检查（太近检测）

**Day 9: 语音/动作丰富**
- [ ] 扩充语音库（多条问候语/送别语）
- [ ] 增加更多 Pose（thumbs_up/invite）
- [ ] 【可选】实现简单语音命令识别（"拍照"）

**Day 10: 集成测试 + Bug 修复**
- [ ] 完整流程测试（迎宾 → 跟随 → 合影 → 送别）
- [ ] 压力测试（连续多人互动）
- [ ] Bug 修复 + 参数微调
- [ ] 录制演示视频

**Week 2 交付物**：真机可演示的 MVP

---

### 9.3 完整状态机（7 状态）

完整版包含 **7 个状态**，按优先级逐步实现：

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      完整状态机（7 状态）                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                         ┌──────────────┐                                │
│                         │  SAFE_STOP   │ ◀─── 任意状态异常触发           │
│                         │  (安全停止)   │                                │
│                         └──────┬───────┘                                │
│                                │ 安全恢复                                │
│                                ▼                                        │
│   ┌────────┐   检测到人脸    ┌────────────┐                             │
│   │  IDLE  │ ──────────────▶ │   SEARCH   │                             │
│   │ (空闲)  │ ◀──────────────  │  (搜寻)    │                             │
│   └────────┘   超时放弃       └─────┬──────┘                             │
│        ▲                           │ 目标确认                            │
│        │                           ▼                                    │
│        │                    ┌────────────┐                              │
│        │                    │  TRACKING  │ ◀─── 采访/合影完成返回         │
│        │                    │  (跟随)     │                              │
│        │                    └──┬─────┬───┘                              │
│        │                       │     │                                  │
│        │        ┌──────────────┘     └──────────────┐                   │
│        │        │ 手势/语音触发                      │ 语音/命令触发      │
│        │        ▼                                   ▼                   │
│        │  ┌──────────────┐                   ┌──────────────┐           │
│        │  │ PHOTO_POSING │                   │  INTERVIEW   │           │
│        │  │   (合影)      │                   │   (采访)     │           │
│        │  └──────┬───────┘                   └──────┬───────┘           │
│        │         │ 完成                              │ 完成              │
│        │         ▼                                   │                  │
│        │  ┌──────────────┐                           │                  │
│        │  │   FAREWELL   │ ◀─────────────────────────┘                  │
│        │  │    (送别)    │   目标离开                                    │
│        │  └──────┬───────┘                                              │
│        │         │ 完成                                                  │
│        └─────────┘                                                       │
└─────────────────────────────────────────────────────────────────────────┘
```

### 9.4 状态开发顺序

按以下顺序逐步实现各状态：

| 阶段 | 状态 | 优先级 | 当前进度 | 说明 |
|------|------|--------|----------|------|
| **阶段 1** | IDLE | P0 必须 | ✅ 已完成 | 待机微动，等待目标 |
| **阶段 1** | SAFE_STOP | P0 必须 | 🔲 待开发 | 安全停止，异常处理 |
| **阶段 2** | SEARCH | P1 重要 | 🔲 待开发 | 搜寻目标，确认意向 |
| **阶段 2** | TRACKING | P1 重要 | 🔲 待开发 | 跟随互动，自由沟通 |
| **阶段 3** | PHOTO_POSING | P1 重要 | 🔲 待开发 | 合影动作，倒数快门 |
| **阶段 3** | FAREWELL | P2 可选 | 🔲 待开发 | 挥手送别 |
| **阶段 4** | INTERVIEW | P3 延后 | 🔲 待开发 | 采访录制 |

### 9.5 降级策略

| 完整版功能 | 降级方案 |
|------------|----------|
| 大模型对话 | 使用预设语音库随机播放 |
| 语音命令识别 | 仅手势触发 + ROS2 命令 |
| 采访录制 | INTERVIEW 状态延后实现 |
| 实时推流 | 不实现，延后 |
| SEARCH 状态 | 可简化合并到 TRACKING |

### 9.6 风险与应对

| 风险 | 概率 | 影响 | 应对措施 |
|------|------|------|----------|
| 真机调试时间不足 | 中 | 高 | 仿真优先验证 |
| 关节控制不稳定 | 中 | 高 | 使用保守参数，减小动作幅度 |
| 手势识别误触发 | 中 | 中 | 增加确认时间阈值 |
| 语音播放延迟 | 低 | 低 | 使用本地预录音 |
| 状态转换异常 | 中 | 中 | SAFE_STOP 兜底 |

### 9.7 后续迭代

基础状态机完成后，可逐步扩展：

- **V1.0**：完成 7 状态基础功能（IDLE/SEARCH/TRACKING/PHOTO_POSING/FAREWELL/INTERVIEW/SAFE_STOP）
- **V1.1**：接入大模型对话（TRACKING 状态）
- **V1.2**：完善采访录制功能（INTERVIEW 状态）
- **V1.3**：语音命令识别
- **V1.4**：多人目标切换
- **V1.5**：实时推流到大屏

---

## 10. 安全策略

### 10.1 软件安全

| 安全措施 | 描述 |
|----------|------|
| **关节限幅** | 所有关节输出 clamp 到物理限位内 |
| **速度限制** | 最大角速度 1.0 rad/s（伴随动作更低） |
| **看门狗** | 上层命令超时 2s → 回中立位 |
| **太近检测** | 目标距离 < 0.5m → 停止动作 + 语音提示 |

### 10.2 操作安全

| 安全措施 | 描述 |
|----------|------|
| **外部急停** | 支持 ROS2 `stop` 命令立即停止 |
| **状态监控** | 实时发布状态，便于操作员监控 |
| **模式检查** | 启动前检查 `/motion/motion_state` 是否允许控制 |

---

## 11. 附录

### 11.1 术语表

| 术语 | 说明 |
|------|------|
| FSM | Finite State Machine，有限状态机 |
| VAD | Voice Activity Detection，语音活动检测 |
| TTS | Text-to-Speech，文本转语音 |
| STT | Speech-to-Text，语音转文本 |
| LLM | Large Language Model，大语言模型 |

### 11.2 参考文档

- `docs/wedding_robot_design.md` - 智能迎宾版详细设计
- `docs/wedding_robot_interviewer_design.md` - 采访记者版原始需求
- `engineai_ros2_workspace/src/interface_protocol/README.md` - EngineAI 接口协议

