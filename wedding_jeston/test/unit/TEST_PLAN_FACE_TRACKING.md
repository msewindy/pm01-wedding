# 人脸追踪功能测试方案

## 测试目标

验证以下功能：
1. **FaceIDTracker**：跨帧 ID 追踪的准确性
2. **FaceDetector**：集成 ID 追踪器后的人脸检测和 ID 分配
3. **IDLE 状态**：在多个人脸中选择最大正脸，并维护候选追踪
4. **SEARCH 状态**：从 IDLE 接收 face_id 并成功追踪目标
5. **IDLE → SEARCH 集成**：完整的状态转换和 face_id 传递

## 测试用例

### 1. FaceIDTracker 单元测试

#### 1.1 基本 ID 分配
- **输入**：连续多帧的人脸检测结果
- **预期**：每张人脸分配唯一的持久化 ID
- **验证**：相同人脸在不同帧中保持相同 ID

#### 1.2 跨帧匹配
- **输入**：模拟人脸移动（位置和大小变化）
- **预期**：基于 IoU 和位置距离正确匹配
- **验证**：匹配率 > 90%

#### 1.3 多目标追踪
- **输入**：多个人脸同时出现
- **预期**：每个人脸都有独立的 ID
- **验证**：ID 不重复，追踪稳定

#### 1.4 目标丢失和清理
- **输入**：人脸消失一段时间后重新出现
- **预期**：丢失后清理，重新出现时分配新 ID
- **验证**：清理机制正常工作

### 2. FaceDetector 集成测试

#### 2.1 ID 追踪启用测试
- **输入**：启用追踪的 FaceDetector
- **预期**：检测到的人脸都有有效的 face_id (>= 0)
- **验证**：face_id 分配正确

#### 2.2 跨帧 ID 稳定性
- **输入**：同一张图片多次检测（模拟连续帧）
- **预期**：相同人脸保持相同 face_id
- **验证**：ID 稳定性 > 95%

#### 2.3 追踪统计
- **输入**：多帧检测
- **预期**：追踪统计信息正确
- **验证**：匹配率、活跃追踪数等统计准确

### 3. IDLE 状态测试

#### 3.1 多脸选择最大正脸
- **输入**：包含多个正脸的图片
- **预期**：选择面积最大的正脸作为候选
- **验证**：候选的 area 是最大的

#### 3.2 候选跨帧匹配
- **输入**：模拟多帧检测（同一图片）
- **预期**：候选能正确匹配（使用 face_id）
- **验证**：匹配成功率 > 90%

#### 3.3 候选确认逻辑
- **输入**：候选持续出现 3 秒
- **预期**：候选被确认，创建 LockedTarget
- **验证**：LockedTarget 包含正确的 face_id

### 4. SEARCH 状态测试

#### 4.1 从 IDLE 接收 face_id
- **输入**：包含 face_id 的 LockedTarget
- **预期**：FaceTracker 正确设置初始目标
- **验证**：初始目标的 face_id 匹配

#### 4.2 基于 face_id 的追踪
- **输入**：多帧检测，包含目标 face_id
- **预期**：使用 face_id 成功匹配目标
- **验证**：追踪成功率 > 90%

#### 4.3 正脸持续时间计时
- **输入**：目标持续正脸 2 秒
- **预期**：is_target_confirmed 返回 True
- **验证**：确认逻辑正确

### 5. IDLE → SEARCH 集成测试

#### 5.1 完整流程测试
- **输入**：包含多个正脸的图片，模拟完整状态转换
- **预期**：
  1. IDLE 选择最大正脸
  2. IDLE 确认候选（3 秒）
  3. 创建 LockedTarget 并传递 face_id
  4. SEARCH 接收并追踪目标
  5. SEARCH 确认目标（2 秒）
- **验证**：整个流程中 face_id 保持一致

#### 5.2 face_id 传递验证
- **输入**：IDLE 确认的候选
- **预期**：SEARCH 接收的 face_id 与 IDLE 选择的 face_id 一致
- **验证**：face_id 传递链路完整

## 测试数据

### 测试图片
- **文件**：`engineai_ros2_workspace/src/simulation/mujoco/assets/resource/environment/mp4.jpg`
- **特点**：包含 6 个正脸，适合测试多目标场景

### 测试场景

1. **单帧检测**：测试基本检测和 ID 分配
2. **多帧模拟**：同一图片多次检测，模拟连续帧
3. **状态转换**：模拟 IDLE → SEARCH 的完整流程

## 测试指标

### 性能指标
- **检测速度**：单帧检测时间 < 50ms（满足 30fps）
- **追踪匹配率**：> 90%
- **ID 稳定性**：> 95%

### 功能指标
- **选择准确性**：IDLE 选择最大正脸成功率 100%
- **追踪成功率**：SEARCH 追踪目标成功率 > 90%
- **face_id 一致性**：IDLE → SEARCH 传递中 face_id 保持一致

## 测试执行顺序

1. **单元测试**：FaceIDTracker → FaceDetector
2. **状态测试**：IDLE → SEARCH
3. **集成测试**：IDLE → SEARCH 完整流程

## 预期结果

所有测试用例通过，验证：
- ✅ FaceIDTracker 正确分配和维护 ID
- ✅ FaceDetector 集成追踪器后工作正常
- ✅ IDLE 能选择最大正脸并维护追踪
- ✅ SEARCH 能接收 face_id 并成功追踪
- ✅ 完整流程中 face_id 传递正确

